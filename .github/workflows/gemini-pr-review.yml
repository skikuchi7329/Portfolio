name: 'üßê Gemini Pull Request Review'

on:
  issue_comment:
    types:
      - 'created'

concurrency:
  group: '${{ github.workflow }}-${{ github.event.issue.number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

permissions:
  contents: 'read'
  issues: 'write'
  pull-requests: 'write'

jobs:
  review-pr:
    if: |-
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@gemini-review') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    timeout-minutes: 5
    runs-on: 'ubuntu-latest'

    steps:
      - name: 'Checkout code'
        uses: 'actions/checkout@v4'
      
      - name: 'Get PR details'
        id: 'get_pr'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          PR_NUMBER: '${{ github.event.issue.number || github.event.pull_request.number }}'
        run: |-
          set -euo pipefail
          echo "pr_number=${PR_NUMBER}" >> "${GITHUB_OUTPUT}"
          PR_DATA="$(gh pr view "${PR_NUMBER}" --json title,body,additions,deletions,changedFiles,baseRefName,headRefName)"
          echo "pr_data=${PR_DATA}" >> "${GITHUB_OUTPUT}"

          PR_PATCH="$(gh pr diff "${PR_NUMBER}" --patch)"

          PATCH_SIZE=$(echo "${PR_PATCH}" | wc -c)

          MAX_SIZE=80000 
          echo "patch_size=${PATCH_SIZE}" >> "${GITHUB_OUTPUT}"

          if [ "${PATCH_SIZE}" -gt "${MAX_SIZE}" ]; then
            echo "pr_too_large=true" >> "${GITHUB_OUTPUT}"
            echo "::warning::PR diff is too large (${PATCH_SIZE} chars). Skipping Gemini review."
          else
            echo "pr_too_large=false" >> "${GITHUB_OUTPUT}"
            {
              echo "pr_patch<<EOF"
              echo "${PR_PATCH}"
              echo "EOF"
            } >> "${GITHUB_OUTPUT}"
          fi

      - name: 'Run Gemini PR Review'
        if: steps.get_pr.outputs.pr_too_large == 'false'
        uses: 'google-github-actions/run-gemini-cli@v0'
        id: 'gemini_pr_review'
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

          prompt: |-
            ## Role
            You are an expert code reviewer. Your goal is to identify potential bugs and areas for improvement in the provided pull request.

            ## Context
            - Repository: `${{ github.repository }}`
            - PR Number: `${{ steps.get_pr.outputs.pr_number }}`
            - PR Details (JSON): `${{ steps.get_pr.outputs.pr_data }}`
            - PR Diff:
            ```diff
            ${{ steps.get_pr.outputs.pr_patch }}
            ```

            ## Instructions
            1.  **Analyze the Context**: Review the PR details and the code changes in the diff.
            2.  **Identify Issues**: Look for bugs, performance issues, security vulnerabilities, and deviations from best practices.
            3.  **Provide Feedback**: Create a concise, constructive review. For each point, reference the file and line number. If suggesting code changes, use markdown suggestion blocks.
            4.  **Summarize**: Start your review with a brief, high-level summary of the pull request.
            5.  **Be Specific**: Do not give vague feedback. Your comments must be actionable.

      - name: 'Gemini„ÅÆÂá∫Âäõ„Çí„Éá„Éê„ÉÉ„Ç∞„Åô„Çã'
        shell: bash
        run: |
          echo "--- Gemini„É¨„Çπ„Éù„É≥„Çπ„Åì„Åì„Åã„Çâ ---"
          echo "${{ steps.gemini_pr_review.outputs.gemini-response }}"
          echo "--- Gemini„É¨„Çπ„Éù„É≥„Çπ„Åì„Åì„Åæ„Åß ---"

      - name: 'Post Review Comment'
        if: success() && steps.get_pr.outputs.pr_too_large == 'false'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          PR_NUMBER: '${{ steps.get_pr.outputs.pr_number }}'
          REVIEW: '${{ steps.gemini_pr_review.outputs.gemini-response }}'
        run: |
          gh pr comment "${PR_NUMBER}" --body "$REVIEW"

      - name: 'Post Too Large Comment'
        if: steps.get_pr.outputs.pr_too_large == 'true'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          PR_NUMBER: '${{ steps.get_pr.outputs.pr_number }}'
        run: |
          gh pr comment "${PR_NUMBER}" --body "ü§ñ This PR diff is too large for Gemini to review. Please review manually."

      - name: 'Post Failure Comment'
        if: failure() && steps.get_pr.outputs.pr_too_large == 'false'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          PR_NUMBER: '${{ steps.get_pr.outputs.pr_number }}'
          RUN_URL: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
        run: |
          gh pr comment "${PR_NUMBER}" --body "ü§ñ Gemini PR Review failed. Please check the [action logs]($RUN_URL) for details."
